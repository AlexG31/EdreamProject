<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        *{margin:0;padding:0;}
        html,body{line-height:1.3em; font-family: 'Helvetica', 'Arial', sans-serif; background-color: #000;height:100%;width:100%;}
        .wrap-container {position: absolute; top:0;right:0;bottom:0;left:0;margin:90px 110px 300px;display: block;overflow: hidden;}
        .wrap-container img{margin:0 auto;}
        .wrap-container .image-container{overflow:hidden;display: inherit}
        .text-container {position: absolute;left:0;right:0; margin:15px 110px;display:none; z-index:999;text-align: center; max-height:105px;line-height: 35px;}
        .text-container h1{font-weight: normal;}
        /*@font-face {
            font-family: ChineseFont;
            src: url(http://139.199.32.181:9002/SourceHanSansCN-Normal.otf);
        }*/
    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
</head>
<body style="background-color: black;">
<div style="text-align: center">
    <b style="color:white"> *Please click on the center of the page and hit refresh if it doesn't play.</b>
</div>
<div class="container" id = "ImageContainer" style="margin-top: 90px; margin-bottom: 35px; max-height: 500px;background-color: black; height: 500px;">
    <image class="MainImage" style="display: block; min-height: 100px; position: absolute;" id="MainImg1" src=""></image>
   
</div>

<div style="margin-left: auto;margin-right: auto;width:80px;">
    <button class="btn btn-success" style="border: green 1px solid;border-width: 6px;
    width: 150px;" onclick="readcaption()" id="main-btn">
        Start Play
    </button>
</div>
<div class="container">
    <h1 id="storytext" style="text-align: center; color: white;font-size: 50px;line-height: 1;font-family: helvetica;">scene: the inauguration of trump</h1>
    <h1 id="chinesestory" style="text-align: center; color: white; font-family: ChineseFont;font-size: 45px;line-height: 2;">特朗普宣誓的场景</h1>
    <audio src="" autoplay="" id="teller"></audio>
</div>
<script>
    var bodyText = ["The smaller your reality, the more convinced you are that you know everything.", "If the facts don't fit the theory, change the facts.", "The past has no power over the present moment.", "This, too, will pass.", "</p><p>You will not be punished for your anger, you will be punished by your anger.", "Peace comes from within. Do not seek it without.", "<h3>Heading</h3><p>The most important moment of your life is now. The most important person in your life is the one you are with now, and the most important activity in your life is the one you are involved with now."]
    function generateText(sentenceCount) {
        for (var i = 0; i < sentenceCount; i++)
            document.write(bodyText[Math.floor(Math.random() * 7)] + " ")
    }
    rep = 0;

    function readcaption() {
        // console.log('timing event', rep);
        
        var button = document.getElementById('main-btn');
        button.style.display = 'none';
        //ad.play();
        // Change Image
        //document.getElementById('storytext').innerHTML = '';
        ReadDream();
        //calWrap();
        //window.setTimeout(readcaption, 6000);
        
    }

    function PlaySpeech(speechpath) {
         var teller = document.getElementById('teller');
         teller.src = speechpath;
         //speechpath = speechpath.replace()
         //var audio = new Audio(speechpath);
         //audio.play();
         teller.play();
         return teller;
    }
    function ReadDream() {
        console.log('[AJAX]Start dreaming ...')
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            //console.log(this.responseText);
            var dreamJson = JSON.parse(this.responseText);
            // Story Text
            var story = dreamJson.text;
            document.getElementById('storytext').innerHTML = story;
            
            // Image
            
            if ('imagejson' in dreamJson && 
                'value' in dreamJson.imagejson &&
                dreamJson.imagejson.value.length > 0) {
                imagepath = dreamJson.imagejson.value[0].thumbnailUrl;
                var imageinfo = dreamJson.imagejson.value[0];
                ImageReposition(imageinfo);
            } else {
                // Default Image
                var imagepath = 'http://{{server_address}}:9002/default.jpg';
                var imageinfo = {'thumbnailUrl': imagepath, 'thumbnail': {'width': 155, 'height':310}};
                ImageReposition(imageinfo);
                document.getElementById('MainImg1').style.height = "310px";
            }
            //document.getElementById('MainImg1').src = imagepath;
            

            // Chinese
            var chinese = dreamJson.chinese;
            document.getElementById('chinesestory').innerHTML = chinese;

            // Speech
            var speechpath = dreamJson.speechpath;
            console.log('Speech path:' + speechpath);
            //speechpath = 'http://139.199.32.181:9002/v2//9b87d5507c65ace5b01c4243fee3f8f93f40ce2b57bd18f4716fd499bc063070.mp3'
            var speech = PlaySpeech(speechpath);
            //window.setTimeout(readcaption, 6000);
            speech.onended = function () {
                console.log('Audio ended.')
                window.setTimeout(readcaption, 1000);
            }
          }
        };
        var serverUrl = "http://{{server_address}}/talk/dream";
        //var serverUrl = "http://139.199.32.181:8080/talk/dreamclient?name=tom";
        xhttp.open("GET", serverUrl, true);
        xhttp.send();   
    }

    function calWrap() {
        var wrap, image_container, text_container;
        wrap = document.getElementsByClassName('wrap-container')[0];
        text_container = document.getElementsByClassName('text-container')[0];
        text_container.style.display = 'block';
        text_container.style.top = wrap.clientHeight + 90 + 'px';
        image_container = document.getElementsByClassName('image-container')[0];
        image_container.style.position = 'absolute';
        image_container.style.top = '50%';
        image_container.style.left = '50%';
        image_container.style.marginTop = -image_container.clientHeight / 2 + 'px';
        image_container.style.marginLeft = -image_container.clientWidth / 2 + 'px';
    }

    function ClipSize(height, width, max_height) {
        if (height > max_height) {
            nh = max_height;
            nw = width / height * max_height;

            height = nh;
            width = nw;
        }
        return {'height':height, 'width':width};
    }

    function ImageReposition(imageinfo) {

        var img = document.getElementById('MainImg1');
        img.src = imageinfo.thumbnailUrl;
        //img.src = 'https://tse2.mm.bing.net/th?id=OIP.WgaQqMxxicDuNPbPKzfakgAAAA&pid=Api';
        // Image size
        height = imageinfo.thumbnail.height;
        width = imageinfo.thumbnail.width;

        // Clip height
        new_size = ClipSize(height, width, 500);
        height = new_size.height;
        width = new_size.width;
        //height = 150;
        //width = 135;
        console.log('Width, height,', width, height);

        /*var WindowWidth = window.innerWidth
            || document.documentElement.clientWidth
            || document.body.clientWidth;
        console.log('Browser window width', WindowWidth);
        console.log('Browser body width', document.body.clientWidth);*/
        var WindowWidth = document.getElementById('ImageContainer').clientWidth;
        console.log('WindowWidth:', WindowWidth);

        mleft = (WindowWidth - width) / 2;
        mtop = (500 - height) / 2;

        console.log(img);
        img.style.marginLeft = mleft.toString() + "px";
        img.style.marginTop = mtop.toString() + "px";
        img.style.height = height.toString() + "px";
    }

    //window.setTimeout(readcaption, 100);
</script>
</body>
</html>
