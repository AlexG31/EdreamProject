<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        *{margin:0;padding:0;}
        html,body{line-height:1.3em; font-family: 'Helvetica', 'Arial', sans-serif; background-color: #000;height:100%;width:100%;}
        .wrap-container {position: absolute; top:0;right:0;bottom:0;left:0;margin:90px 110px 300px;display: block;overflow: hidden;}
        .wrap-container img{margin:0 auto;}
        .wrap-container .image-container{overflow:hidden;display: inherit}
        .text-container {position: absolute;left:0;right:0; margin:15px 110px;display:none; z-index:999;text-align: center; max-height:105px;line-height: 35px;}
        .text-container h1{font-weight: normal;}
        @font-face {
            font-family: ChineseFont;
            src: url(http://139.199.32.181:9002/SourceHanSansCN-Normal.otf);
        }
    </style>

</head>
<body>
<div class="wrap-container">
    <div class="image-container">
        <image class="MainImage" style="display: block;" id="MainImg1" src="http://139.199.32.181:9002/talk/img/story/s1.jpg"></image>
    </div>
</div>
<div class="text-container">
    <h1 id="storytext" style="text-align: center; color: white;font-size: 50px;line-height: 1;">scene: the inauguration of trump</h1>
    <h1 id="chinesestory" style="text-align: center; color: white; font-family: ChineseFont;font-size: 45px;line-height: 2;">特朗普宣誓的场景</h1>
    <audio src="" autoplay="" id="teller"></audio>
</div>
<script>
    var bodyText = ["The smaller your reality, the more convinced you are that you know everything.", "If the facts don't fit the theory, change the facts.", "The past has no power over the present moment.", "This, too, will pass.", "</p><p>You will not be punished for your anger, you will be punished by your anger.", "Peace comes from within. Do not seek it without.", "<h3>Heading</h3><p>The most important moment of your life is now. The most important person in your life is the one you are with now, and the most important activity in your life is the one you are involved with now."]
    function generateText(sentenceCount) {
        for (var i = 0; i < sentenceCount; i++)
            document.write(bodyText[Math.floor(Math.random() * 7)] + " ")
    }
    rep = 0;

    function readcaption() {
        // console.log('timing event', rep);
        
        //var ad = document.getElementById('aud1')
        //ad.play();
        // Change Image
        document.getElementById('storytext').innerHTML = '';
        ReadDream();
        calWrap();
        //window.setTimeout(readcaption, 6000);
        
    }

    function PlaySpeech(speechpath) {
         var teller = document.getElementById('teller');
         teller.src = speechpath;
         //speechpath = speechpath.replace()
         //var audio = new Audio(speechpath);
         //audio.play();
         teller.play();
         return teller;
    }
    function ReadDream() {
        console.log('[AJAX]Start dreaming ...')
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            console.log(this.responseText);
            var dreamJson = JSON.parse(this.responseText);
            // Story Text
            var story = dreamJson.text;
            document.getElementById('storytext').innerHTML = story;
            // Speech
            var speechpath = dreamJson.speechpath;
            console.log('Speech path:' + speechpath);
            var speech = PlaySpeech(speechpath);

            // Image
            var imagepath = 'http://139.199.32.181:9002/IMG_2818.JPG'
            if ('imagejson' in dreamJson && 
                'value' in dreamJson.imagejson &&
                dreamJson.imagejson.value.length > 0) {
                imagepath = dreamJson.imagejson.value[0].thumbnailUrl;
            }
            document.getElementById('MainImg1').src = imagepath;
            // Chinese
            var chinese = dreamJson.chinese;
            document.getElementById('chinesestory').innerHTML = chinese;

            // Next Image
            calWrap();
            //window.setTimeout(readcaption, 6000);
            speech.onended = function () {
                console.log('Audio ended.')
                window.setTimeout(readcaption, 1000);
            }
          }
        };
        var serverUrl = "http://139.199.32.181:8080/talk/dreamclient?name={{ name }}";
        console.log("Client server url:", serverUrl);
        xhttp.open("GET", serverUrl, true);
        xhttp.send();   
    }

    function calWrap() {
        var wrap, image_container, text_container;
        wrap = document.getElementsByClassName('wrap-container')[0];
        text_container = document.getElementsByClassName('text-container')[0];
        text_container.style.display = 'block';
        text_container.style.top = wrap.clientHeight + 90 + 'px';
        image_container = document.getElementsByClassName('image-container')[0];
        image_container.style.position = 'absolute';
        image_container.style.top = '50%';
        image_container.style.left = '50%';
        image_container.style.marginTop = -image_container.clientHeight / 2 + 'px';
        image_container.style.marginLeft = -image_container.clientWidth / 2 + 'px';
    }

    window.setTimeout(readcaption, 100);
</script>
</body>
</html>
